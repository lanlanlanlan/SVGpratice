<!DOCTYPE html>
<!-- saved from url=(0062)http://www.oxxostudio.tw/demo/201411/svg-d3-02-line-demo1.html -->
<html lang="tw"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  
  <meta name="author" content="oxxo.studio">
  <meta name="copyright" content="oxxo.studio">
  <title>SVG D3.js - 繪製線段 - demo1</title>
  <script src="./js/d3.v3.min.js"></script>
  <script src="./js/three.min.js"></script>
  <script src="./js/math.min.js"></script>
</head>

<body>
  <script>
  /*
  var data = [
    [{x: 10,y: 10}, {x: 50,y: 100}, {x: 60, y: 50  }, {x: 100,y: 30}],
    [{x: 50,y: 50}, {x: 50,y: 100}, {x: 100, y: 100  }, {x: 100,y: 50}]
  ];
  */
  var data = [
    [{x: 50,y: 50}, {x: 50,y: 100}, {x: 100, y: 100  }, {x: 100,y: 50}],
    []
  ];
  var offset = 3;//line offset 
  var svg = d3.select('body')
    .append('svg')
    .attr({
      'width': 400,
      'height': 400
    });

  var line = d3.svg.line()
    .x(function(d) {
      return d.x;
    })
    .y(function(d) {
      return d.y;
    }).interpolate('linear-closed');

  svg.append('path')
    .attr({
      'd': line(data[0]),
      'y': 0,
      'stroke': '#000',
      'stroke-width': '1px',
      'fill': 'none'
    });
  function computeNewNode_old(element){
      for (var i = 0; i <element.length; i++) {
           var m = [element[i]]
      }
  } 

  function computeNewNode(p1, p2, p3) {

    let vectorData = [{x:0, y:0}, {x:0, y:0}];
    vectorData[0] = computeCrossVector( computeVector(p1, p2));
    vectorData[1] = computeCrossVector( computeVector(p2, p3));
    
    let lineData = [], linePx, linePy;

    //first point of line1
    linePx = p1.x + computeUnitVector(vectorData[0]).x*offset;
    linePy = p1.y + computeUnitVector(vectorData[0]).y*offset;
    lineData.push({
      x: linePx ,
      y: linePy
    });
    //end point of line1
    linePx = p2.x + computeUnitVector(vectorData[0]).x*offset;
    linePy = p2.y + computeUnitVector(vectorData[0]).y*offset;
    lineData.push({
      x: linePx ,
      y: linePy
    });
    //first point of line2
    linePx = p2.x + computeUnitVector(vectorData[1]).x*offset;
    linePy = p2.y + computeUnitVector(vectorData[1]).y*offset;
    lineData.push({
      x: linePx ,
      y: linePy
    });
    //end point of line2
    linePx = p3.x + computeUnitVector(vectorData[1]).x*offset;
    linePy = p3.y + computeUnitVector(vectorData[1]).y*offset;
    lineData.push({
      x: linePx ,
      y: linePy
    });
    //console.log(math.intersect([lineData[0].x, lineData[0].y], [lineData[1].x, lineData[1].y], [lineData[1].x, lineData[1].y], [lineData[2].x, lineData[2].y]));
    return math.intersect([lineData[0].x, lineData[0].y], [lineData[1].x, lineData[1].y], [lineData[2].x, lineData[2].y], [lineData[3].x, lineData[3].y]);
    
  }
  function createOffsetPoint(){
      
      if(data[0].length <2)
          console.log("node <= 2");
      else{

          data[1].push({
            x: computeNewNode(data[0][data[0].length-1],data[0][0],data[0][1])[0] ,
            y: computeNewNode(data[0][data[0].length-1],data[0][0],data[0][1])[1]
          });
          for(let i = 0 ;i < data[0].length-1 ; i++){
              if((i+2) > data[0].length-1){
                  data[1].push({
                    x: computeNewNode(data[0][i],data[0][i+1],data[0][0])[0] ,
                    y: computeNewNode(data[0][i],data[0][i+1],data[0][0])[1]
                  })
              }
              else{
                  data[1].push({
                    x: computeNewNode(data[0][i],data[0][i+1],data[0][i+2])[0] ,
                    y: computeNewNode(data[0][i],data[0][i+1],data[0][i+2])[1]
                  })
                }
                
              }
              console.log(data[1]);
      }
      /*
      data[1].push({
            x: computeNewNode(data[0][0],data[0][1],data[0][2])[0] ,
            y: computeNewNode(data[0][0],data[0][1],data[0][2])[1]
          });
      data[1].push({
            x: computeNewNode(data[0][1],data[0][2],data[0][3])[0] ,
            y: computeNewNode(data[0][1],data[0][2],data[0][3])[1]
          });

      data[1].push({
            x: computeNewNode(data[0][2],data[0][3],data[0][0])[0] ,
            y: computeNewNode(data[0][2],data[0][3],data[0][0])[1]
          });

      data[1].push({
            x: computeNewNode(data[0][3],data[0][0],data[0][1])[0] ,
            y: computeNewNode(data[0][3],data[0][0],data[0][1])[1]
          });
      console.log(data[1]);
      */
  }

  function computeVector(p1, p2){
      return { 
        x:(p2.x - p1.x) ,
        y:(p2.y - p1.y)
      };
  }
  
  function computeCrossVector(p){
    var temp = -p.x;
    p.x = p.y;
    p.y = temp;
    return p;
  }
  function computeUnitVector(p){
    var v = { x:p.x , y:p.y};
    var length = Math.sqrt(Math.pow(p.x, 2) + Math.pow(p.y, 2));
    v.x /= length ;
    v.y /= length;
    return v;
  }
  function computeSlope(p1 ,p2){
      return ((p2.y-p1.y)/(p2.x-p1.x));
  }
  //update()
  function updateData() {

   svg.selectAll("*").remove();
    svg.append('path')
    .attr({
      'd': line(data[0]),
      'y': 0,
      'stroke': '#000',
      'stroke-width': '1px',
      'fill': 'none'
    });
    
    svg.append('path')
    .attr({
      'd': line(data[1]),
      'y': 0,
      'stroke': '#000',
      'stroke-width': '1px',
      'fill': 'none'
    });
    
}
  </script>
  <!--
  <svg width="800" height="800"><path d="M10,10L50,100L60,50L100,30" y="0" stroke="#000" stroke-width="5px" fill="none"></path></svg>
    -->
    <div id="option">
    <input name="updateButton" 
                 type="button" 
                value="Update" 
                onclick="updateData()" />
    </div>
    <div id="compute">
    <input name="computeButton" 
                 type="button" 
                value="compute" 
                onclick="createOffsetPoint()" />
    </div>

</body></html>